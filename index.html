<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬ä¼—å·è¡¨æ ¼é…å›¾ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #1d1d1f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
        }

        h1 {
            font-size: 48px;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 18px;
            color: #6e6e73;
            font-weight: 400;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .upload-area {
            border: 2px dashed #d2d2d7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: #6e6e73;
            margin-bottom: 12px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .style-options {
            display: grid;
            gap: 20px;
        }

        .option-group {
            margin-bottom: 16px;
        }

        .option-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .option-item {
            padding: 12px;
            border: 2px solid #e8e8ed;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            background: white;
        }

        .option-item:hover {
            border-color: #667eea;
        }

        .option-item.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            font-weight: 600;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            margin: 0 auto 6px;
            border: 2px solid #e8e8ed;
        }

        .preview-section {
            grid-column: 1 / -1;
        }

        #tablePreview {
            overflow-x: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .table-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        .watermark-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .watermark-text {
            position: absolute;
            color: rgba(128, 128, 128, 0.15);
            font-size: 28px;
            font-family: Microsoft YaHei, sans-serif;
            white-space: nowrap;
            transform: rotate(-25deg);
            user-select: none;
            z-index: 10;
        }

        .preview-table {
            position: relative;
            z-index: 2;
            background: white;
        }

        .preview-table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .export-section {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 14px;
        }

        .export-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            color: #86868b;
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .column-width-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            background: transparent;
        }

        .resizer:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .preview-table th {
            position: relative;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 36px;
            }

            .option-grid {
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            }
        }

        .preview-table th,
        .preview-table td {
            padding: 14px 16px;
            text-align: left;
            border: 1px solid #e8e8ed;
        }

        /* Force font inheritance */
        .preview-table * {
            font-family: inherit !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>è¡¨æ ¼é…å›¾ç”Ÿæˆå™¨</h1>
            <p class="subtitle">è®©ä½ çš„å…¬ä¼—å·æ•°æ®æ›´ç²¾ç¾</p>
        </header>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="card">
                <h2 class="card-title">ğŸ“¤ ä¸Šä¼ æ•°æ®</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“Š</div>
                    <p class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                    <p style="font-size: 13px; color: #86868b;">æ”¯æŒ Excel (.xlsx, .xls) å’Œ CSV æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                </div>

                <div class="option-group">
                    <label class="option-label">æˆ–ç²˜è´´è¡¨æ ¼æ–‡æœ¬ï¼ˆæ”¯æŒ CSV å’Œ Markdownï¼‰</label>
                    <textarea id="markdownInput"
                        placeholder="æ”¯æŒä¸¤ç§æ ¼å¼ï¼š&#10;&#10;CSVæ ¼å¼ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼š&#10;åˆ—1,åˆ—2,åˆ—3&#10;æ•°æ®1,æ•°æ®2,æ•°æ®3&#10;&#10;Markdownæ ¼å¼ï¼š&#10;| åˆ—1 | åˆ—2 | åˆ—3 |&#10;|------|------|------|&#10;| æ•°æ®1 | æ•°æ®2 | æ•°æ®3 |"></textarea>
                </div>
                <button class="btn" onclick="parseText()" style="width: 100%; margin-top: 12px;">è§£æè¡¨æ ¼</button>
            </div>

            <!-- Style Options -->
            <div class="card">
                <h2 class="card-title">ğŸ¨ æ ·å¼è®¾ç½®</h2>

                <div class="option-group">
                    <label class="option-label">é…è‰²æ–¹æ¡ˆ</label>
                    <div class="option-grid">
                        <div class="option-item active" onclick="selectStyle('color', 'tech', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                            <div>ç§‘æŠ€ç´«</div>
                        </div>
                        <div class="option-item" onclick="selectStyle('color', 'claude', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #CC785C 0%, #D4876F 100%);"></div>
                            <div>Claudeé£</div>
                        </div>
                        <div class="option-item" onclick="selectStyle('color', 'apple', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #000000 0%, #434343 100%);"></div>
                            <div>è‹¹æœé»‘</div>
                        </div>
                        <div class="option-item" onclick="selectStyle('color', 'ocean', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);"></div>
                            <div>æ·±æµ·è“</div>
                        </div>
                        <div class="option-item" onclick="selectStyle('color', 'cyber', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                            <div>ç”µå­è“</div>
                        </div>
                        <div class="option-item" onclick="selectStyle('color', 'fresh', this)">
                            <div class="color-preview"
                                style="background: linear-gradient(135deg, #5DADE2 0%, #85C1E9 100%);"></div>
                            <div>æ¸…æ–°è“</div>
                        </div>
                    </div>
                </div>

                <div class="option-group">
                    <label class="option-label">å­—ä½“æ ·å¼</label>
                    <div class="option-grid">
                        <div class="option-item active" onclick="selectStyle('font', 'yahei', this)">å¾®è½¯é›…é»‘</div>
                        <div class="option-item" onclick="selectStyle('font', 'songti', this)">å®‹ä½“</div>
                        <div class="option-item" onclick="selectStyle('font', 'kaiti', this)">æ¥·ä½“</div>
                        <div class="option-item" onclick="selectStyle('font', 'heiti', this)">é»‘ä½“</div>
                        <div class="option-item" onclick="selectStyle('font', 'fangsong', this)">ä»¿å®‹</div>
                        <div class="option-item" onclick="selectStyle('font', 'system', this)">ç³»ç»Ÿå­—ä½“</div>
                    </div>
                </div>

                <div class="option-group">
                    <label class="option-label">è¡¨æ ¼æ ·å¼</label>
                    <div class="option-grid">
                        <div class="option-item active" onclick="selectStyle('table', 'stripe', this)">æ–‘é©¬çº¹</div>
                        <div class="option-item" onclick="selectStyle('table', 'border', this)">è¾¹æ¡†çº¿</div>
                        <div class="option-item" onclick="selectStyle('table', 'minimal', this)">æç®€é£</div>
                    </div>
                </div>

                <div class="option-group">
                    <label class="option-label">å­—å·å¤§å°</label>
                    <div class="option-grid">
                        <div class="option-item" onclick="selectStyle('size', 'small', this)">å°å·</div>
                        <div class="option-item active" onclick="selectStyle('size', 'medium', this)">æ ‡å‡†</div>
                        <div class="option-item" onclick="selectStyle('size', 'large', this)">å¤§å·</div>
                    </div>
                </div>

                <div class="option-group">
                    <label class="option-label">åˆ—å®½æ¨¡å¼</label>
                    <div class="column-width-controls">
                        <button class="btn btn-secondary" onclick="setColumnWidth('auto')">è‡ªé€‚åº”å†…å®¹</button>
                        <button class="btn btn-secondary" onclick="setColumnWidth('equal')">å‡åŒ€åˆ†å¸ƒ</button>
                        <button class="btn btn-secondary" onclick="setColumnWidth('compact')">ç´§å‡‘æ¨¡å¼</button>
                    </div>
                    <p style="font-size: 12px; color: #86868b; margin-top: 8px;">ğŸ’¡ æç¤ºï¼šè¡¨æ ¼æ¸²æŸ“åå¯æ‹–åŠ¨åˆ—è¾¹ç•Œè°ƒæ•´å®½åº¦</p>
                </div>

                <div class="option-group">
                    <label class="option-label">è¡¨æ ¼æ ‡é¢˜</label>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="showTitle" onchange="toggleTitle()"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span>æ˜¾ç¤ºæ ‡é¢˜</span>
                        </label>
                        <input type="text" id="tableTitle" class="export-input" placeholder="è¯·è¾“å…¥è¡¨æ ¼æ ‡é¢˜" style="flex: 1;"
                            oninput="renderTable()" disabled>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="card preview-section">
                <h2 class="card-title">ğŸ‘ï¸ å®æ—¶é¢„è§ˆ</h2>
                <div id="tablePreview">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <p>ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´è¡¨æ ¼æ•°æ®åå³å¯é¢„è§ˆ</p>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="card preview-section">
                <h2 class="card-title">ğŸ’¾ å¯¼å‡ºè®¾ç½®</h2>
                <div class="export-section">
                    <input type="text" class="export-input" id="watermark" placeholder="è¾“å…¥æ°´å°æ–‡å­—ï¼ˆé€‰å¡«ï¼‰">
                    <select class="export-input" id="imageSize" style="flex: 0.5;">
                        <option value="1">åŸå§‹å°ºå¯¸</option>
                        <option value="1.5">1.5å€</option>
                        <option value="2" selected>2å€ï¼ˆæ¨èï¼‰</option>
                        <option value="3">3å€</option>
                    </select>
                    <button class="btn" onclick="copyImage()"
                        style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">ğŸ“‹ å¤åˆ¶å›¾ç‰‡</button>
                    <button class="btn" onclick="exportImage()">ğŸ“¥ å¯¼å‡ºå›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tableData = null;
        let columnWidths = [];
        const styleConfig = {
            color: 'tech',
            font: 'yahei',
            table: 'stripe',
            size: 'medium',
            widthMode: 'auto'
        };

        const colorSchemes = {
            claude: { header: 'linear-gradient(135deg, #CC785C 0%, #D4876F 100%)', stripe: '#FDF8F6', text: '#1d1d1f' },
            apple: { header: 'linear-gradient(135deg, #000000 0%, #434343 100%)', stripe: '#F5F5F7', text: '#1d1d1f' },
            tech: { header: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', stripe: '#f7f8fc', text: '#1d1d1f' },
            ocean: { header: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)', stripe: '#f0fdfa', text: '#1d1d1f' },
            cyber: { header: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', stripe: '#f0f9ff', text: '#1d1d1f' },
            fresh: { header: 'linear-gradient(135deg, #5DADE2 0%, #85C1E9 100%)', stripe: '#D6EAF8', text: '#1d1d1f', titleBg: '#5DADE2' }
        };

        const fontFamilies = {
            system: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            yahei: 'Microsoft YaHei, å¾®è½¯é›…é»‘, PingFang SC, Hiragino Sans GB, sans-serif',
            songti: 'SimSun, å®‹ä½“, STSong, NSimSun, serif',
            kaiti: 'KaiTi, æ¥·ä½“, STKaiti, KaiTi_GB2312, serif',
            heiti: 'SimHei, é»‘ä½“, Microsoft JhengHei, STHeiti, sans-serif',
            fangsong: 'FangSong, ä»¿å®‹, STFangsong, serif',
            serif: 'Georgia, Times New Roman, serif',
            mono: 'Courier New, Courier, monospace'
        };

        const fontSizes = {
            small: { header: '18px', body: '16px' },
            medium: { header: '22px', body: '18px' },
            large: { header: '28px', body: '24px' }
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();

            if (ext === 'csv') {
                Papa.parse(file, {
                    complete: (results) => {
                        tableData = results.data.filter(row => row.some(cell => cell.trim()));
                        initializeColumnWidths();
                        renderTable();
                    },
                    skipEmptyLines: true
                });
            } else if (ext === 'xlsx' || ext === 'xls') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    tableData = jsonData.filter(row => row.some(cell => cell !== undefined && cell !== ''));
                    initializeColumnWidths();
                    renderTable();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseText() {
            const text = document.getElementById('markdownInput').value.trim();
            if (!text) return;

            const lines = text.split('\n').filter(line => line.trim());
            let data = [];

            // æ£€æµ‹æ˜¯ Markdown è¿˜æ˜¯ CSV æ ¼å¼
            const isMarkdown = lines.some(line => line.includes('|'));
            const isCSV = !isMarkdown && lines.some(line => line.includes(','));

            if (isMarkdown) {
                // è§£æ Markdown è¡¨æ ¼
                for (let line of lines) {
                    if (line.includes('|')) {
                        const cells = line.split('|')
                            .map(cell => cell.trim())
                            .filter(cell => cell && !cell.match(/^[-:]+$/));
                        if (cells.length > 0) data.push(cells);
                    }
                }
            } else if (isCSV) {
                // è§£æ CSV æ ¼å¼ï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼‰
                for (let line of lines) {
                    // ä½¿ç”¨æ›´æ™ºèƒ½çš„ CSV è§£æï¼Œå¤„ç†å¼•å·å†…çš„é€—å·
                    const cells = parseCSVLine(line);
                    if (cells.length > 0) data.push(cells);
                }
            } else {
                // å°è¯• Tab åˆ†éš”
                for (let line of lines) {
                    if (line.includes('\t')) {
                        const cells = line.split('\t').map(cell => cell.trim());
                        if (cells.length > 0) data.push(cells);
                    }
                }
            }

            if (data.length > 0) {
                tableData = data;
                initializeColumnWidths();
                renderTable();
            } else {
                alert('æ— æ³•è¯†åˆ«è¡¨æ ¼æ ¼å¼ï¼Œè¯·ä½¿ç”¨ CSVï¼ˆé€—å·åˆ†éš”ï¼‰æˆ– Markdown æ ¼å¼');
            }
        }

        // è§£æ CSV è¡Œï¼Œæ”¯æŒå¼•å·å†…çš„é€—å·
        function parseCSVLine(line) {
            const cells = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªå•å…ƒæ ¼
            cells.push(current.trim());

            return cells;
        }

        // ä¿ç•™æ—§å‡½æ•°åä»¥å…¼å®¹
        function parseMarkdown() {
            parseText();
        }

        function initializeColumnWidths() {
            if (!tableData || tableData.length === 0) return;
            const colCount = Math.max(...tableData.map(row => row.length));
            columnWidths = new Array(colCount).fill('auto');
        }

        function setColumnWidth(mode) {
            if (!tableData || tableData.length === 0) return;

            styleConfig.widthMode = mode;
            const colCount = Math.max(...tableData.map(row => row.length));

            if (mode === 'auto') {
                columnWidths = new Array(colCount).fill('auto');
            } else if (mode === 'equal') {
                columnWidths = new Array(colCount).fill('200px');
            } else if (mode === 'compact') {
                columnWidths = new Array(colCount).fill('120px');
            }

            renderTable();
        }

        function selectStyle(category, value, element) {
            const siblings = element.parentElement.children;
            for (let sibling of siblings) {
                sibling.classList.remove('active');
            }
            element.classList.add('active');
            styleConfig[category] = value;
            renderTable();
        }

        function toggleTitle() {
            const checkbox = document.getElementById('showTitle');
            const titleInput = document.getElementById('tableTitle');
            titleInput.disabled = !checkbox.checked;
            if (checkbox.checked) {
                titleInput.focus();
            }
            renderTable();
        }

        function renderTable() {
            if (!tableData || tableData.length === 0) return;

            const preview = document.getElementById('tablePreview');
            const scheme = colorSchemes[styleConfig.color];
            const font = fontFamilies[styleConfig.font];
            const sizes = fontSizes[styleConfig.size];

            let html = '';

            // æ·»åŠ æ°´å°é¢„è§ˆå±‚
            const watermark = document.getElementById('watermark').value.trim();
            if (watermark) {
                html += '<div class="watermark-preview" id="watermarkLayer"></div>';
            }

            // æ·»åŠ è¡¨æ ¼æ ‡é¢˜
            const showTitle = document.getElementById('showTitle').checked;
            const titleText = document.getElementById('tableTitle').value.trim();

            // å¼€å§‹å®¹å™¨
            html += '<div class="table-container">';

            if (showTitle && titleText) {
                const titleBg = scheme.titleBg || scheme.header;
                html += `<div style="background: ${titleBg}; color: white; text-align: center; padding: 16px 24px; font-size: ${parseInt(sizes.header) + 4}px; font-weight: 700; font-family: ${font} !important; border-radius: 8px 8px 0 0; margin-bottom: 0;">${titleText}</div>`;
            }

            const tableRadius = showTitle && titleText ? 'border-radius: 0 0 8px 8px;' : '';
            html += `<table class="preview-table" id="mainTable" style="font-family: ${font} !important; ${tableRadius}">`;

            if (tableData.length > 0) {
                html += '<thead><tr>';
                for (let i = 0; i < tableData[0].length; i++) {
                    const width = columnWidths[i] || 'auto';
                    html += `<th data-col="${i}" style="background: ${scheme.header}; color: white; font-size: ${sizes.header}; font-weight: 600; width: ${width}; min-width: 80px; position: relative; font-family: ${font} !important;">
                        ${tableData[0][i] || ''}
                        <div class="resizer" data-col="${i}"></div>
                    </th>`;
                }
                html += '</tr></thead>';
            }

            html += '<tbody>';
            for (let i = 1; i < tableData.length; i++) {
                const rowStyle = styleConfig.table === 'stripe' && i % 2 === 0 ? `background: ${scheme.stripe};` : '';
                const borderStyle = styleConfig.table === 'minimal' ? 'border: none; border-bottom: 1px solid #e8e8ed;' : '';
                html += `<tr style="${rowStyle}">`;
                for (let j = 0; j < tableData[i].length; j++) {
                    html += `<td style="color: ${scheme.text}; font-size: ${sizes.body}; ${borderStyle}; font-family: ${font} !important;">${tableData[i][j] !== undefined ? tableData[i][j] : ''}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';

            preview.innerHTML = html;

            if (watermark) {
                renderWatermarkPreview();
            }

            attachResizeListeners();
        }

        function renderWatermarkPreview() {
            const watermarkLayer = document.getElementById('watermarkLayer');
            if (!watermarkLayer) return;

            const watermark = document.getElementById('watermark').value.trim();
            if (!watermark) return;

            const preview = document.getElementById('tablePreview');
            const width = preview.offsetWidth;
            const height = preview.offsetHeight;

            const spacingX = 350;
            const spacingY = 250;
            const cols = Math.ceil(width / spacingX) + 2;
            const rows = Math.ceil(height / spacingY) + 2;

            let html = '';
            for (let row = -1; row < rows; row++) {
                for (let col = -1; col < cols; col++) {
                    const x = col * spacingX;
                    const y = row * spacingY;
                    html += `<div class="watermark-text" style="left: ${x}px; top: ${y}px;">${watermark}</div>`;
                }
            }

            watermarkLayer.innerHTML = html;
        }

        // ç›‘å¬æ°´å°è¾“å…¥
        document.addEventListener('DOMContentLoaded', function () {
            const watermarkInput = document.getElementById('watermark');
            if (watermarkInput) {
                watermarkInput.addEventListener('input', function () {
                    if (tableData && tableData.length > 0) {
                        renderTable();
                    }
                });
            }
        });

        function attachResizeListeners() {
            const resizers = document.querySelectorAll('.resizer');
            let currentResizer = null;
            let startX = 0;
            let startWidth = 0;

            resizers.forEach(resizer => {
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    currentResizer = resizer;
                    const col = parseInt(resizer.dataset.col);
                    const th = resizer.parentElement;
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!currentResizer) return;
                const diff = e.pageX - startX;
                const newWidth = Math.max(80, startWidth + diff);
                const col = parseInt(currentResizer.dataset.col);
                columnWidths[col] = newWidth + 'px';

                const th = currentResizer.parentElement;
                th.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (currentResizer) {
                    currentResizer = null;
                    document.body.style.cursor = 'default';
                }
            });
        }

        function exportImage() {
            const preview = document.getElementById('tablePreview');
            const watermark = document.getElementById('watermark').value.trim();
            const scale = parseFloat(document.getElementById('imageSize').value);

            if (typeof html2canvas === 'undefined') {
                alert('å¯¼å‡ºåŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ‰ç½‘ç»œè¿æ¥');
                return;
            }

            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = 'white';
            tempDiv.style.padding = '6px';
            tempDiv.innerHTML = preview.innerHTML;
            document.body.appendChild(tempDiv);

            html2canvas(tempDiv, {
                scale: scale,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                document.body.removeChild(tempDiv);

                if (watermark) {
                    const ctx = canvas.getContext('2d');
                    const fontSize = 28 * scale;
                    ctx.font = `${fontSize}px Microsoft YaHei, sans-serif`;
                    ctx.fillStyle = 'rgba(128, 128, 128, 0.15)';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const angle = -25 * Math.PI / 180;
                    const spacingX = 350 * scale;
                    const spacingY = 250 * scale;

                    // ä¸æ—‹è½¬æ•´ä¸ªç”»å¸ƒï¼Œè€Œæ˜¯é€ä¸ªç»˜åˆ¶æ—‹è½¬çš„æ–‡å­—
                    const cols = Math.ceil(canvas.width / spacingX) + 2;
                    const rows = Math.ceil(canvas.height / spacingY) + 2;

                    for (let row = -1; row < rows; row++) {
                        for (let col = -1; col < cols; col++) {
                            const x = col * spacingX;
                            const y = row * spacingY;

                            ctx.save();
                            ctx.translate(x, y);
                            ctx.rotate(angle);
                            ctx.fillText(watermark, 0, 0);
                            ctx.restore();
                        }
                    }
                }

                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `table-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            }).catch(err => {
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
            });
        }

        async function copyImage() {
            const preview = document.getElementById('tablePreview');
            const watermark = document.getElementById('watermark').value.trim();
            const scale = parseFloat(document.getElementById('imageSize').value);

            if (!tableData || tableData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æˆ–ç²˜è´´è¡¨æ ¼æ•°æ®');
                return;
            }

            if (typeof html2canvas === 'undefined') {
                alert('åŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ‰ç½‘ç»œè¿æ¥');
                return;
            }

            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå‰ªè´´æ¿ API
            if (!navigator.clipboard || !navigator.clipboard.write) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå¤åˆ¶å›¾ç‰‡åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½');
                return;
            }

            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = 'white';
            tempDiv.style.padding = '6px';
            tempDiv.innerHTML = preview.innerHTML;
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv, {
                    scale: scale,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                document.body.removeChild(tempDiv);

                // æ·»åŠ æ°´å°
                if (watermark) {
                    const ctx = canvas.getContext('2d');
                    const fontSize = 28 * scale;
                    ctx.font = `${fontSize}px Microsoft YaHei, sans-serif`;
                    ctx.fillStyle = 'rgba(128, 128, 128, 0.15)';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const angle = -25 * Math.PI / 180;
                    const spacingX = 350 * scale;
                    const spacingY = 250 * scale;

                    const cols = Math.ceil(canvas.width / spacingX) + 2;
                    const rows = Math.ceil(canvas.height / spacingY) + 2;

                    for (let row = -1; row < rows; row++) {
                        for (let col = -1; col < cols; col++) {
                            const x = col * spacingX;
                            const y = row * spacingY;

                            ctx.save();
                            ctx.translate(x, y);
                            ctx.rotate(angle);
                            ctx.fillText(watermark, 0, 0);
                            ctx.restore();
                        }
                    }
                }

                // å°† canvas è½¬æ¢ä¸º blob å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showCopySuccess();
            } catch (err) {
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼š' + err.message + '\n\nè¯·å°è¯•ä½¿ç”¨å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½');
            }
        }

        function showCopySuccess() {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.innerHTML = 'âœ… å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white;
                padding: 20px 40px;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 600;
                box-shadow: 0 10px 40px rgba(17, 153, 142, 0.4);
                z-index: 10000;
                animation: fadeInOut 2s ease-in-out forwards;
            `;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(toast);

            // 2ç§’åç§»é™¤
            setTimeout(() => {
                document.body.removeChild(toast);
                document.head.removeChild(style);
            }, 2000);
        }
    </script>
</body>

</html>